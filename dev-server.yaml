---
- hosts: all
  become: false

  tasks:
    - name: Install base packages
      become: true
      apt:
        state: present
        update_cache: true
        name:
          - zlib1g-dev
          - make
          - clang
          - unzip
          - libssl-dev
          - editorconfig
          - rustc
          - entr
          - vim
          - zsh
          - git
          - llvm
          - autoconf
          - fd-find
          - ripgrep

    - name: Symlink fd
      file:
        state: link
        src: "/usr/bin/fdfind"
        dest: "/usr/bin/fd"

    - name: Install snaps
      command: "snap install --classic {{ item }}"
      with_items:
        - universal-ctags
      become: yes

    - name: Copy ssh key
      copy:
        src: ~/.ssh/id_rsa
        dest: ~/.ssh/id_rsa
        mode: 0600

    - name: Install asdf
      git:
        dest: ~/.asdf
        repo: "git@github.com:asdf-vm/asdf.git"
        accept_hostkey: yes
        update: no
      tags: [asdf, install]

    - name: Install asdf plugins
      command: "asdf plugin-add {{ item }}"
      args:
        creates: "~/.asdf/plugins/{{ item }}"
      tags: [asdf]
      environment:
        PATH: "{{ ansible_env.PATH }}:/home/vagrant/.asdf/bin"
      with_items:
        - elixir
        - erlang
        - nodejs
        - terraform

    - name: Add asdf-nodejs keyring
      command: bash ~/.asdf/plugins/nodejs/bin/import-release-team-keyring
      tags: [asdf]

    - name: Install pyenv
      git:
        dest: ~/.pyenv
        repo: "git@github.com:pyenv/pyenv.git"
        accept_hostkey: yes
        update: no
      tags: [pyenv, install]

    - name: Install pyenv-virtualenv
      git:
        dest: ~/.pyenv/plugins/pyenv-virtualenv
        repo: "git@github.com:pyenv/pyenv-virtualenv.git"
        accept_hostkey: yes
        update: no
      tags: [pyenv, install]

    - name: Add Docker GPG apt Key
      become: yes
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
      tags: [docker, install]

    - name: Add Docker Repository
      become: yes
      apt_repository:
        repo: deb https://download.docker.com/linux/ubuntu bionic stable
        state: present
      tags: [docker, install]

    - name: Update apt and install docker-ce
      become: yes
      apt:
        update_cache: yes
        name:
          - docker-ce
          - docker-compose
        state: latest
      tags: [docker, install]

    - name: Create docker group
      become: yes
      group:
        name: docker
      tags: [docker, install]

    - name: Add current user to docker group
      become: yes
      user:
        name: "{{ lookup('env', 'USER') }}"
        append: yes
        groups:
          - docker
      tags: [docker]

    - name: bashrc
      copy:
        src: bashrc
        dest: ~/.bashrc
